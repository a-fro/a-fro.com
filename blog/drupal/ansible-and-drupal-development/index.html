<!DOCTYPE html>
<html lang="en" dir="ltr" prefix="og: https://ogp.me/ns#">
  <head>
    <meta charset="utf-8" />
<link rel="canonical" href="https://www.a-fro.com/blog/drupal/ansible-and-drupal-development" />
<meta name="description" content="As I mentioned in my hello world post, I&#039;ve been learning Ansible via Jeff Geerling&#039;s great book Ansible for Devops. When learning new technologies, there is no substitute for diving in and playing with them on a real project. This blog is, in part, the byproduct of my efforts to learn and play with Ansible." />
<meta property="og:site_name" content="a-fro.com" />
<meta property="og:title" content="Ansible and Drupal Development" />
<meta property="og:description" content="As I mentioned in my hello world post, I&#039;ve been learning Ansible via Jeff Geerling&#039;s great book Ansible for Devops. When learning new technologies, there is no substitute for diving in and playing with them on a real project. This blog is, in part, the byproduct of my efforts to learn and play with Ansible." />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:description" content="As I mentioned in my hello world post, I&#039;ve been learning Ansible via Jeff Geerling&#039;s great book Ansible for Devops. When learning new technologies, there is no substitute for diving in and playing with them on a real project. This blog is, in part, the byproduct of my efforts to learn and play with Ansible." />
<meta name="twitter:title" content="Ansible and Drupal Development | a-fro.com" />
<meta name="Generator" content="Drupal 9 (https://www.drupal.org)" />
<meta name="MobileOptimized" content="width" />
<meta name="HandheldFriendly" content="true" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="icon" href="/themes/custom/simple_base/favicon.ico" type="image/vnd.microsoft.icon" />

    <title>Ansible and Drupal Development | a-fro.com</title>
    <link rel="stylesheet" media="all" href="/sites/default/files/css/css_Ov6iUDly3SngZgRuyy-vYboSettyRJo1rXFjgCfc1Jo.css" />
<link rel="stylesheet" media="all" href="/sites/default/files/css/css_PJMDxwkMigKO_2N1HQiw7IqRu5kH5nGq1b5ZNHaXhnc.css" />
<link rel="stylesheet" media="all" href="//maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css" />
<link rel="stylesheet" media="all" href="//fonts.googleapis.com/css?family=Merriweather:300,300italic,700,700italic,400,400italic|Merriweather+Sans:400,400italic,700,700italic,300italic,300" />
<link rel="stylesheet" media="all" href="/sites/default/files/css/css_h1Arqe21okfZvJPMUbix_twJpOxI9xFaFj2m1dyf5Mk.css" />

    
  </head>
  <body class="path-node page-node-type-post">
        <a href="#main-content" class="visually-hidden focusable skip-link">
      Skip to main content
    </a>
    
      <div class="dialog-off-canvas-main-canvas" data-off-canvas-main-canvas>
    

<div class="layout-container">

  <header class="layout-header full-width" role="banner">
      <div class="region region-header">
    <div id="block-simple-base-branding" class="block block-system block-system-branding-block">
  
    
          <div class="site-name">
      <a href="/" rel="home">a-fro.com</a>
    </div>
    </div>

  </div>

    <div class="region region--highlighted">
      <div class="content__container">
          <div class="region region-highlighted">
    <div id="block-breadcrumbs--4" class="block block-system block-system-breadcrumb-block">
  
    
        <nav class="breadcrumb" role="navigation" aria-labelledby="system-breadcrumb">
    <h2 id="system-breadcrumb" class="visually-hidden">Breadcrumb</h2>
    <ol>
          <li>
                  <a href="/">Home</a>
              </li>
          <li>
                  <a href="/blog">Blog</a>
              </li>
          <li>
                  <a href="/blog/drupal">Drupal</a>
              </li>
        </ol>
  </nav>

  </div>
<div id="block-simple-base-page-title--4" class="block block-core block-page-title-block">
  
    
      
  <h1 class="page-title"><span class="field field--name-title field--type-string field--label-hidden">Ansible and Drupal Development</span>
</h1>


  </div>

  </div>

      </div>
    </div>
  </header>

  <main role="main" class="layout-main">
    <a id="main-content" tabindex="-1"></a>      <div class="region region-content">
    <div data-drupal-messages-fallback class="hidden"></div>
<div id="block-mainpagecontent--4" class="block block-system block-system-main-block">
  
    
      
<article role="article" class="node node--type-post node--promoted node--view-mode-full">
  
  <div class="node__content">
    
            <div class="field field--name-field-published-date field--type-datetime field--label-hidden field__item"><time datetime="2014-10-22T12:00:00Z" class="datetime">October 22, 2014</time>
</div>
      
      <div class="field field--name-field-components field--type-entity-reference-revisions field--label-hidden field__items">
              <div class="field__item">  <div class="paragraph paragraph--type--rich-text paragraph--view-mode--default">
          
            <div class="clearfix text-formatted field field--name-field-body field--type-text-long field--label-hidden field__item"><p>As I mentioned in my <a href="/hello-world-from-drupal-8">hello world post</a>, I've been learning Ansible via Jeff Geerling's great book <a href="https://leanpub.com/ansible-for-devops">Ansible for Devops</a>. When learning new technologies, there is no substitute for diving in and playing with them on a real project. This blog is, in part, the byproduct of my efforts to learn and play with Ansible. Yet embedded within that larger goal were a number of additional technical requirements that were important to me, including:</p>

<ol>
	<li>Setting up a local development environment using Vagrant</li>
	<li>Installing Drupal from a github repo</li>
	<li>Configuring Vagrant to run said repo over NFS (for ST3, LiveReload, Sass, etc.)</li>
	<li>Using the same playbook for both local dev and remote administration (on DigitalOcean)</li>
	<li>Including basic server security</li>
	<li>Making deployments simple</li>
</ol>

<p>In this blog entry, we'll look at the first three requirements in greater detail, and save the latter three for another post.</p>

<h3>Configuring Local Development with Vagrant</h3>

<p>At first glance, requirement #1 seems pretty simple. Ansible plays nicely with Vagrant, so if all you want to do is quickly spin up a Drupal site, download Jeff's <a href="https://github.com/geerlingguy/drupal-dev-vm">Drupal Dev VM</a> and you'll be up and running in a matter of minutes. However, when taken in the context of the 2nd and 3rd requirements, we're going to need to make some modifications to the Drupal Dev VM.</p>

<p>To start with, the Drupal Dev VM uses a drush make file to build the site. Since we want to build the site based on our own git repository, we're going to need to find a different strategy. This is actually a recent modification to the Drupal Dev VM, which previously used an Ansible role called <a href="https://github.com/geerlingguy/ansible-role-drupal">"Drupal"</a>. If you look carefully at that github repo, you'll actually notice that Jeff accepted one of my pull requests to add the functionality we're looking for from this role. The last variable is called drupal_repo_url, which you can use if you want to install Drupal from your own repository rather than Drupal.org. We'll take a closer look at this in a moment.</p>

<h3>Installing Drupal with a Custom Git Repo</h3>

<p>Heading back to the <a href="https://github.com/geerlingguy/drupal-dev-vm">Drupal Dev VM</a>, you can see that the principle change Jeff made was to remove geerlingguy.drupal from the dependency list, and replace it with a new task defined in the <a href="https://github.com/geerlingguy/drupal-dev-vm/blob/master/provisioning/tasks/drupal.yml">drupal.yml</a> file. After cloning the Dev VM onto your system, remove <code>- include: tasks/drupal.yml</code> from the tasks section and add <code>- geerlingguy.drupal</code> to the roles section.</p>

<p>After replacing the Drupal task with the Ansible Drupal role, we also need to update the <a href="https://github.com/geerlingguy/drupal-dev-vm/blob/master/provisioning/vars/main.yml">vars file</a> in the local repo with the <a href="https://github.com/geerlingguy/ansible-role-drupal/blob/master/defaults/main.yml">role-specific vars</a>. There, you can update the <code>drupal_repo_url</code> to point to your github url rather than the project url at git.drupal.org.</p>

<h3>Configuring Vagrant for NFS</h3>

<p>At this point, we would be able to meet the first two requirements with a simple <code>vagrant up</code>, which would provision the site using Ansible (assuming that you've already installed the dependencies). Go ahead and try it if you're following along on your local machine. But there's a problem, because our third requirement is going to complicate this setup. Currently, Drupal gets downloaded and installed on the VM, which complicates our ability to edit the files using our IDE of choice and also being able to run the necessary Ruby gems like Sass and LiveReload.</p>

<p>When I was initially working through this process, I spent quite a few hours trying to configure my VM to download the necessary Ruby gems so I could compile my stylesheets with Compass directly on the VM. The biggest drawback for me, however, was that I didn't really want to edit my code using Vim over ssh. What I really needed was to be able to share my local git repo of the site with my Vagrant box via NFS, hence the 3rd requirement.</p>

<p>In order to satisfy this 3rd requirement, I ended up removing my dependency on the Ansible Drupal role and instead focussed on modifying the Drupal task to meet my needs. Take a look at <a href="https://gist.github.com/a-fro/5ce79021260575336193">this gist</a> to see what I did.</p>

<p>Most of the tasks in that file should be pretty self-explanatory. The only one that might be suprising is the "Copy the css files" task, which is necessary because I like to keep my compiled CSS files out of the repo (more on this coming soon). Here's a gist of an example <a href="https://gist.github.com/a-fro/4796be4b0ec6e9d37422">vars file</a> you could use to support this task.</p>

<p>One other advantage of our modified Drupal task is that we can now specify an install profile to use when installing Drupal. I currently have a <a href="https://github.com/geerlingguy/ansible-role-drupal/pull/6">pull request</a> that would add this functionality to the Ansible Drupal Role, but even if that gets committed, it won't solve our problem here because we're not using that role. We could, however, simply modify the "Install Drupal (standard profile) with drush" to install our custom profile if that's part of your typical workflow. If I were installing a D7 site here, I would definitely use a custom profile, since that is my standard workflow, but since we're installing D8 and I haven't used D8 profiles yet, I'm leaving it out for now.</p>

<p>The next step we need to take in order to get our site working correctly is to modify the <a href="https://github.com/geerlingguy/drupal-dev-vm/blob/master/Vagrantfile">Vagrantfile</a> so that we share our local site. You might have noticed in the <a href="https://gist.github.com/a-fro/4796be4b0ec6e9d37422">vars file</a> that the <code>drupal_css_path</code> variable points to a folder on my system named "a-fro.dev", which is, not suprisingly, the folder we want to load over NFS. This can be accomplished by adding the following line to the Vagrantfile:</p>

<p><code>config.vm.synced_folder "../a-fro.dev", "/var/www/a-fro.dev", :nfs =&gt; true</code></p>

<p>Note that the folder we point to in /var/www should match the <code>{{ drupal_domain</code> }} variable we previously declared. However, since this is now pointing to a folder on our local system (rather than on the vm), we'll run into a couple of issues when Ansible provisions the VM. Vagrant expects the synced_folder to exist, and will throw an error if it does not. Therefore, you need to make sure an point to an existing folder that includes the path specified in <code>{{ drupal_core_path }}</code>. Alternatively, you could clone a-fro.com repo into the folder above your drupal-dev-vm folder using the command <code>git clone git@github.com:a-fro/a-fro.com.git a-fro.dev</code>. Additionally, you will probably receive an error when the www.yml task tries to set permissions on the www folder. The final change we need to make, then, is to remove the "Set permissions on /var/www" task from provisioning/tasks/www.yml</p>

<p>With this final change in place, we should now be able to run <code>vagrant up</code> and the the site should install correctly. If it doesn't work for you, one possible gotcha is with the task that checks if Drupal is already installed. That task looks for the settings.php file, and if it finds it, the Drush site-install task doesn't run. If you're working from a previously installed local site, the settings.php file may already exist.</p>

<h3>Conclusion</h3>

<p>This completes our first three requirements, and should get you far enough that you could begin working on building your own local site and getting it ready to deploy to your new server. You can find the <a href="https://github.com/a-fro/drupal-dev-vm/tree/part1">final working version</a> from this post on GitHub. In the next blog post, we'll look more closely at the last three requirements, which I had to tackle in order to get the site up and running. Thanks for reading.</p>
</div>
      
      </div>
</div>
          </div>
  
  <div class="field field--name-field-tags field--type-entity-reference field--label-above">
    <div class="field__label">Tags</div>
          <div class="field__items">
              <div class="field__item"><a href="/blog/drupal" hreflang="en">Drupal</a></div>
              </div>
      </div>

  </div>
</article>

  </div>
<div class="views-element-container block block-views block-views-blockrelated-content-block-1" id="block-views-block-related-content-block-1--4">
  
      <h2>Up Next</h2>
    
      <div><div class="view view-related-content view-id-related_content view-display-id-block_1 js-view-dom-id-44629a8a75ff6add2a1b6b416058a40d614cd565219ef38e90452bb2c1c320be">
  
    
      
      <div class="view-content">
          <div class="views-row">
<article role="article" class="node node--type-post node--promoted node--view-mode-teaser">
    
      <h2>
      <a href="/blog/drupal/creating-reusable-dynamic-content-components" rel="bookmark"><span class="field field--name-title field--type-string field--label-hidden">Creating Reusable Dynamic Content Components</span>
</a>
    </h2>
    
  
  <div class="node__content">
    
            <div class="field field--name-field-representative-image field--type-entity-reference field--label-hidden field__item">  <a href="/blog/drupal/creating-reusable-dynamic-content-components" hreflang="en"><img src="/sites/default/files/styles/medium_21_9/public/2021-12/reusable-components.jpg?itok=M349LY0e" width="798" height="342" alt="A screenshot showing the &quot;up next&quot; reusable tagged content block " loading="lazy" class="image-style-medium-21-9" />

</a>
</div>
      
            <div class="clearfix text-formatted field field--name-body field--type-text-with-summary field--label-hidden field__item">This is part 2 in this series that explores how to use paragraph bundles to store configuration for dynamic content. The example I built in part 1 was a "read next" section, which could then be added as a component within the flow of the page. The strategy makes sense for component-based sites and landing pages, but probably less so for blogs or content heavy sites, since what we really want is for each article to include the read next section at the end of the page. For that, a view that displays as a block would perfectly suffice. In practice, however, it can be really useful to have a single custom block type, which I often call a "component block", that has an entity reference revisions field that we can leverage to create reusable components.</div>
      
  <div class="field field--name-field-tags field--type-entity-reference field--label-above">
    <div class="field__label">Tags</div>
          <div class="field__items">
              <div class="field__item"><a href="/blog/drupal" hreflang="en">Drupal</a></div>
              </div>
      </div>

  </div>
</article>
</div>
    <div class="views-row">
<article role="article" class="node node--type-post node--promoted node--view-mode-teaser">
    
      <h2>
      <a href="/blog/drupal/drupal-pullquotes" rel="bookmark"><span class="field field--name-title field--type-string field--label-hidden">Drupal Pullquotes</span>
</a>
    </h2>
    
  
  <div class="node__content">
    
            <div class="field field--name-field-representative-image field--type-entity-reference field--label-hidden field__item">  <a href="/blog/drupal/drupal-pullquotes" hreflang="en"><img src="/sites/default/files/styles/medium_21_9/public/2021-12/pullqoutes.png?itok=tGjYx72p" width="798" height="342" alt="Several powerful quotes with a pullquote sprinkled off to the side to draw a reader&#039;s attention" loading="lazy" class="image-style-medium-21-9" />

</a>
</div>
      
            <div class="clearfix text-formatted field field--name-body field--type-text-with-summary field--label-hidden field__item">"Pullquotes", as described here, differ from blockquotes because they duplicate a section of text within the page, and get styled in a way that draws the reader's attention to the quote. As such, one simple solution that I've been using is to allow content editors to select a section of text while editing and click a button in the interface to designate it as a pullquote.</div>
      
  <div class="field field--name-field-tags field--type-entity-reference field--label-above">
    <div class="field__label">Tags</div>
          <div class="field__items">
              <div class="field__item"><a href="/blog/drupal" hreflang="en">Drupal</a></div>
              </div>
      </div>

  </div>
</article>
</div>
    <div class="views-row">
<article role="article" class="node node--type-post node--promoted node--view-mode-teaser">
    
      <h2>
      <a href="/blog/drupal/creating-paragraphs-entities-dynamic-content" rel="bookmark"><span class="field field--name-title field--type-string field--label-hidden">Creating Paragraphs Entities for Dynamic Content</span>
</a>
    </h2>
    
  
  <div class="node__content">
    
            <div class="field field--name-field-representative-image field--type-entity-reference field--label-hidden field__item">  <a href="/blog/drupal/creating-paragraphs-entities-dynamic-content" hreflang="en"><img src="/sites/default/files/styles/medium_21_9/public/2021-12/dynamic-content-paragraphs.png?itok=vm1bDqAN" width="798" height="342" alt="Logos  with Paragraphs, Drupal and Atomic Design" loading="lazy" class="image-style-medium-21-9" />

</a>
</div>
      
            <div class="clearfix text-formatted field field--name-body field--type-text-with-summary field--label-hidden field__item">The paragraphs module has become a central ingredient for many component-based sites in recent years. However, our content strategy also often requires components that display dynamic content (think "Read Next", or "Also of Interest"). In this tutorial, I'll demonstrate how we've been solving this problem, by building paragraph bundles that serve as configuration entities that we can then use as arguments that we pass to a view via the Twig Tweak module. You can see a working version of the dynamic content component we'll be building in the "Up Next" card grid at the bottom of this tutorial. </div>
      
  <div class="field field--name-field-tags field--type-entity-reference field--label-above">
    <div class="field__label">Tags</div>
          <div class="field__items">
              <div class="field__item"><a href="/blog/drupal" hreflang="en">Drupal</a></div>
              </div>
      </div>

  </div>
</article>
</div>

    </div>
  
          </div>
</div>

  </div>

  </div>

  </main>

  <footer class="layout-footer full-width" role="contentinfo">
    <div class="content__container">
      
      &copy; 2022
    </div>
  </footer>
</div>
  </div>

    
    <script type="application/json" data-drupal-selector="drupal-settings-json">{"path":{"baseUrl":"\/","scriptPath":null,"pathPrefix":"","currentPath":"node\/9","currentPathIsAdmin":false,"isFront":false,"currentLanguage":"en"},"pluralDelimiter":"\u0003","suppressDeprecationErrors":true,"user":{"uid":0,"permissionsHash":"d296343800a3c10b172401621770f813b6b60761c12b4bdc0222ccbc78f546e6"}}</script>
<script src="/sites/default/files/js/js_ZS9AjodWcK9bqkxTfsDFRvKHxRQ6BESfmM7P1pqgki8.js"></script>

  </body>
</html>
